<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>農地マップ by bicfly</title>

  <!-- スマホ表示の最適化 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* 全体レイアウト */
    body {
      margin: 0;
      font-family: sans-serif;
      position: relative;
    }
    h2 {
      margin: 10px;
    }
    p {
      margin: 0 10px;
    }

    /* 
      PCの場合: height: 90vh 
      スマホなら後述の @media で上書き
    */
    #map {
      width: 100%;
      height: 90vh;
      position: relative;
    }

    /* メニューUI */
    #menu-controls {
      display: none;
      padding: 10px;
      background: rgba(255, 255, 255, 0.8);
      position: absolute;
      top: 10px;
      left: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 10; /* マップ上に重ねる */
    }
    .menu-btn {
      margin: 5px;
      padding: 10px;
      cursor: pointer;
      border: none;
      font-size: 1rem;
      border-radius: 4px;
      background-color: #333;
      color: #fff;
    }

    /* 色ボタンの共通スタイル */
    #color-options {
      display: none; /* 初期は非表示 */
      margin-top: 10px;
    }
    .color-btn {
      margin: 5px;
      padding: 10px;
      cursor: pointer;
      border: none;
      font-size: 1rem;
      border-radius: 4px;
      min-width: 60px;
      color: #fff;
    }
    .color-btn.red   { background-color: red; }
    .color-btn.blue  { background-color: blue; }
    .color-btn.green { background-color: green; }

    /* スマホ向けに調整: 幅600px以下の場合 */
    @media (max-width: 600px) {
      /* 地図を少し小さめ (高さ60%) */
      #map {
        height: 60vh;
      }
      .menu-btn,
      .color-btn {
        width: 100%;
        margin: 5px 0;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <h2>農地管理</h2>
  <p>ポリゴンをクリックするとメニューが表示されます。</p>

  <!-- メニュー (初期非表示) -->
  <div id="menu-controls">
    <button class="menu-btn" onclick="toggleEdit()">編集</button>
    <button class="menu-btn" onclick="toggleColorOptions()">ステータスの変更</button>
    <button class="menu-btn" onclick="goToPolygon()">この場所へ行く</button>
    <button class="menu-btn" onclick="deletePolygon()">ポリゴンを削除</button>
    <button class="menu-btn" onclick="closeMenu()">メニューを閉じる</button>

    <!-- 色変更ボタンたち（初期は非表示） -->
    <div id="color-options">
      <button class="color-btn green" onclick="changePolygonColor('green')">未散布</button>
      <button class="color-btn blue"  onclick="changePolygonColor('blue')">散布済</button>
      <button class="color-btn red"   onclick="changePolygonColor('red')">その他</button>
    </div>
  </div>

  <!-- マップを表示するエリア -->
  <div id="map"></div>

  <!-- Google Maps API -->
  <script
    async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiuOKh_PSyULKO48_aSdPZfUSTQaJgKPk&libraries=drawing&callback=initMap">
  </script>

  <!-- Firebase をモジュールとして読み込む -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, collection, doc, getDocs, setDoc, onSnapshot, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebaseプロジェクト設定
    const firebaseConfig = {
      apiKey: "AIzaSyDcML77RLR-r1YLh9a0nwzdeEhw1bTwNNo",
      authDomain: "map-polygon-10435.firebaseapp.com",
      projectId: "map-polygon-10435",
      storageBucket: "map-polygon-10435.firebasestorage.app",
      messagingSenderId: "193815114515",
      appId: "1:193815114515:web:dba42836c1a9f5b99f60e6"
    };
    // Firebase初期化
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const polygonsCollection = collection(db, "polygons");

    window.db = db;
    window.polygonsCollection = polygonsCollection;

    // Firestoreからポリゴンを読み込み
    async function loadPolygons() {
      try {
        const querySnapshot = await getDocs(polygonsCollection);
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const polygonCoords = data.coords;
          const color = data.color || "yellow";

          if (window.polygonMap && window.polygonMap[docSnap.id]) {
            return; // 重複描画防止
          }

          const polygon = new google.maps.Polygon({
            paths: polygonCoords,
            strokeColor: color,
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: color,
            fillOpacity: 0.35,
            editable: false,
            draggable: false,
            map: window.map,
          });

          // クリックでメニューを表示
          polygon.addListener("click", () => {
            handlePolygonClick(docSnap.id);
          });

          window.polygonMap[docSnap.id] = polygon;

          // リアルタイム監視で色更新
          onSnapshot(doc(db, "polygons", docSnap.id), (updatedSnap) => {
            if (updatedSnap.exists() && window.polygonMap[docSnap.id]) {
              const newData = updatedSnap.data();
              const newColor = newData.color || "yellow";
              window.polygonMap[docSnap.id].setOptions({
                fillColor: newColor,
                strokeColor: newColor
              });
            }
          });
        });
      } catch (error) {
        console.error("Error loading polygons:", error);
      }
    }

    // 新規ポリゴン保存
    async function savePolygon(polygon) {
      try {
        const polygonId = `polygon_${Date.now()}`;
        const polygonRef = doc(db, "polygons", polygonId);

        const path = polygon.getPath().getArray().map(latLng => ({
          lat: latLng.lat(),
          lng: latLng.lng()
        }));

        await setDoc(polygonRef, { coords: path, color: "yellow" });

        window.polygonMap[polygonId] = polygon;

        polygon.addListener("click", () => {
          handlePolygonClick(polygonId);
        });

        onSnapshot(polygonRef, (docSnap) => {
          if (docSnap.exists()) {
            const newColor = docSnap.data().color || "yellow";
            polygon.setOptions({ fillColor: newColor, strokeColor: newColor });
          }
        });

        console.log("Polygon saved:", polygonId);
      } catch (error) {
        console.error("Error saving polygon:", error);
      }
    }

    // ポリゴンをクリックしたとき
    function handlePolygonClick(polygonId) {
      Object.keys(window.polygonMap).forEach(id => {
        window.polygonMap[id].setOptions({ strokeWeight: 2 });
      });
      window.polygonMap[polygonId].setOptions({ strokeWeight: 4 });
      window.selectedPolygon = polygonId;

      document.getElementById("menu-controls").style.display = "block";
      document.getElementById("color-options").style.display = "none";
    }

    // 編集モード切り替え
    function toggleEdit() {
      if (!window.selectedPolygon || !window.polygonMap[window.selectedPolygon]) {
        alert("ポリゴンが選択されていません");
        return;
      }
      const poly = window.polygonMap[window.selectedPolygon];
      const isEditable = poly.getEditable();
      poly.setOptions({ editable: !isEditable, draggable: !isEditable });
    }

    // ステータス(色変更)メニューを開閉
    function toggleColorOptions() {
      const colorOptions = document.getElementById("color-options");
      colorOptions.style.display = (colorOptions.style.display === "none" || !colorOptions.style.display)
        ? "block"
        : "none";
    }

    // 色を変更
    async function changePolygonColor(color) {
      if (!window.selectedPolygon || !window.polygonMap[window.selectedPolygon]) {
        alert("ポリゴンを選択してください。");
        return;
      }
      const polygonId = window.selectedPolygon;
      try {
        await setDoc(doc(db, "polygons", polygonId), { color: color }, { merge: true });
        window.polygonMap[polygonId].setOptions({ fillColor: color, strokeColor: color });
        console.log(`Changed color of ${polygonId} to ${color}`);
      } catch (error) {
        console.error("Error changing polygon color:", error);
      }
    }

    // この場所へ行く(ポリゴン中心へナビ)
    function goToPolygon() {
      if (!window.selectedPolygon || !window.polygonMap[window.selectedPolygon]) {
        alert("ポリゴンが選択されていません。");
        return;
      }
      const poly = window.polygonMap[window.selectedPolygon];
      const center = getPolygonCenter(poly);

      // Google Mapsのルート検索URL
      const url = `https://www.google.com/maps/dir/?api=1&destination=${center.lat},${center.lng}`;
      window.open(url, "_blank");
    }

    // ポリゴン中心計算
    function getPolygonCenter(polygon) {
      const path = polygon.getPath().getArray();
      let latSum = 0, lngSum = 0;
      path.forEach(latLng => {
        latSum += latLng.lat();
        lngSum += latLng.lng();
      });
      return {
        lat: latSum / path.length,
        lng: lngSum / path.length
      };
    }

    // 削除
    async function deletePolygon() {
      if (!window.selectedPolygon || !window.polygonMap[window.selectedPolygon]) {
        alert("削除対象のポリゴンが選択されていません。");
        return;
      }
      const polygonId = window.selectedPolygon;
      if (!confirm("削除しますか？")) return;

      try {
        await deleteDoc(doc(db, "polygons", polygonId));
        const poly = window.polygonMap[polygonId];
        poly.setMap(null);
        delete window.polygonMap[polygonId];
        closeMenu();
      } catch (error) {
        console.error("Error deleting polygon:", error);
        alert("ポリゴンの削除に失敗しました。");
      }
    }

    // メニューを閉じる
    function closeMenu() {
      document.getElementById("menu-controls").style.display = "none";
      if (window.selectedPolygon && window.polygonMap[window.selectedPolygon]) {
        window.polygonMap[window.selectedPolygon].setOptions({ strokeWeight: 2 });
      }
      window.selectedPolygon = null;
    }

    // 現在地を取得してマップ中央に移動
    function locateMe() {
      if (!navigator.geolocation) {
        alert("このブラウザは位置情報取得に対応していません。");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          console.log("Current position:", lat, lng);

          const userPos = { lat, lng };
          window.map.setCenter(userPos);
          window.map.setZoom(17);

          if (window.userMarker) {
            window.userMarker.setMap(null);
          }
          window.userMarker = new google.maps.Marker({
            position: userPos,
            map: window.map,
            title: "現在地"
          });
        },
        (err) => {
          console.error("Geolocation error:", err);
          alert("位置情報の取得に失敗しました。ブラウザの設定を確認してください。");
        }
      );
    }

    // グローバル公開
    window.loadPolygons = loadPolygons;
    window.savePolygon = savePolygon;
    window.changePolygonColor = changePolygonColor;
    window.handlePolygonClick = handlePolygonClick;
    window.toggleEdit = toggleEdit;
    window.toggleColorOptions = toggleColorOptions;
    window.locateMe = locateMe;
    window.deletePolygon = deletePolygon;
    window.closeMenu = closeMenu;
    window.goToPolygon = goToPolygon;
  </script>

  <!-- Google Maps 用の初期化: ページロード後に現在地へ移動を試みる -->
  <script>
    window.map = null;
    window.drawingManager = null;
    window.selectedPolygon = null;
    window.polygonMap = {};

    function initMap() {
      // 仮の初期座標 (東京) を設定し、マップを生成
      window.map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.6895, lng: 139.6917 },
        zoom: 18,
        mapTypeId: "satellite",
        gestureHandling: "greedy",
        tilt: 0,     
        heading: 0
      });

      // 1. サイトを開いたら最初に現在地へ移動を試みる
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            console.log("User location:", lat, lng);

            // 現在地へ移動
            window.map.setCenter({ lat, lng });
            window.map.setZoom(17);

            // 現在地マーカーを立てる（省略可）
            window.userMarker = new google.maps.Marker({
              position: { lat, lng },
              map: window.map,
              title: "現在地"
            });
          },
          (err) => {
            console.warn("現在地の取得が許可されなかった/エラー:", err);
            // ここでは何もしない => 東京のまま表示
          }
        );
      }

      // 2. DrawingManager(移動モード)
      window.drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER,
          drawingModes: [google.maps.drawing.OverlayType.POLYGON],
        },
        polygonOptions: {
          editable: false,
          draggable: false,
          fillColor: "yellow",
          strokeColor: "yellow",
        },
      });
      window.drawingManager.setMap(window.map);

      // 新規ポリゴン作成
      google.maps.event.addListener(window.drawingManager, "overlaycomplete", function(event) {
        if (event.type === google.maps.drawing.OverlayType.POLYGON) {
          if (typeof window.savePolygon === "function") {
            window.savePolygon(event.overlay);
          } else {
            console.error("savePolygon 関数が未定義です。");
          }
          event.overlay.setOptions({ editable: false, draggable: false });
        }
      });

      // 3. Firestoreから既存ポリゴンを読み込み
      if (typeof window.loadPolygons === "function") {
        window.loadPolygons();
      } else {
        setTimeout(() => {
          if (typeof window.loadPolygons === "function") {
            window.loadPolygons();
          }
        }, 2000);
      }
    }
  </script>

  <!-- 現在地を取得するボタンをUIとして追加 (任意) -->
  <button style="position:absolute; bottom:20px; left:20px; z-index:10;"
          onclick="locateMe()">
    現在地を表示
  </button>
</body>
</html>
